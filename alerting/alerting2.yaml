apiVersion: 1
groups:
    - orgId: 1
      name: Main_KPIs_Airlines
      folder: Main KPIs
      interval: 10s
      rules:
        # --- KPI 1 : Latence API < 200ms ---
        - uid: kpi_latency_p95
          title: "KPI: Latence API > 200ms"
          condition: C
          data:
            - refId: A
              datasourceUid: Prometheus
              model:
                expr: avg(histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))) * 1000
            - refId: C
              datasourceUid: __expr__
              model:
                type: threshold
                expression: A
                conditions:
                    - evaluator: {params: [200], type: gt}
                      operator: {type: and}
                      reducer: {type: last}
                      type: query

        # --- KPI 2 : Disponibilité > 99.9% ---
        - uid: kpi_availability
          title: "KPI: Disponibilité < 99.9%"
          condition: C
          data:
            - refId: A
              datasourceUid: Prometheus
              model:
                expr: sum(rate(http_requests_total{code=~"2..|3.."}[5m])) / sum(rate(http_requests_total[5m]))
            - refId: C
              datasourceUid: __expr__
              model:
                type: threshold
                expression: A
                conditions:
                    - evaluator: {params: [0.999], type: lt}
                      operator: {type: and}
                      reducer: {type: last}
                      type: query

        # --- KPI 3 : R2 > 80% ---
        - uid: kpi_ml_r2
          title: "KPI: Score R2 < 80%"
          condition: C
          data:
            - refId: A
              datasourceUid: Prometheus
              model:
                expr: ml_model_r2_score{status="production"}
            - refId: C
              datasourceUid: __expr__
              model:
                type: threshold
                expression: A
                conditions:
                    - evaluator: {params: [0.8], type: lt}
                      operator: {type: and}
                      reducer: {type: last}
                      type: query

        # --- KPI 4 : MAE < 25 minutes ---
        - uid: kpi_ml_mae
          title: "KPI: Erreur MAE > 25 min"
          condition: C
          data:
            - refId: A
              datasourceUid: Prometheus
              model:
                expr: ml_model_mae{status="production"}
            - refId: C
              datasourceUid: __expr__
              model:
                type: threshold
                expression: A
                conditions:
                    - evaluator: {params: [25], type: gt}
                      operator: {type: and}
                      reducer: {type: last}
                      type: query